name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  check:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux

      - name: Install Linux dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libpulse-dev pkg-config libasound2-dev libgtk-3-dev libxdo-dev libappindicator3-dev

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Audit advisories
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check advisories

      - name: Run tests
        run: cargo test --lib

  release-windows:
    name: Build & Release (Windows)
    needs: [check]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: windows

      - name: Build release binaries
        run: cargo build --release

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install cargo-wix
        run: cargo binstall cargo-wix --no-confirm

      - name: Build MSI installer
        run: cargo wix -p focusmute --no-build --nocapture

      # Code signing via SignPath Foundation (free for open source).
      # Skipped gracefully when SIGNPATH_API_TOKEN is not configured.
      # To enable: add SIGNPATH_API_TOKEN secret and update the org/project/policy slugs.
      - name: Upload unsigned artifacts for signing
        if: ${{ env.SIGNPATH_API_TOKEN != '' }}
        env:
          SIGNPATH_API_TOKEN: ${{ secrets.SIGNPATH_API_TOKEN }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-signing-package
          path: |
            target/release/focusmute.exe
            target/release/focusmute-cli.exe
            target/wix/*.msi

      - name: Sign Windows artifacts (SignPath)
        if: ${{ env.SIGNPATH_API_TOKEN != '' }}
        env:
          SIGNPATH_API_TOKEN: ${{ secrets.SIGNPATH_API_TOKEN }}
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ vars.SIGNPATH_ORG_ID }}
          project-slug: focusmute
          signing-policy-slug: release-signing
          artifact-configuration-slug: windows-release
          github-artifact-id: ${{ steps.upload-signing.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: signed-artifacts

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            target/release/focusmute.exe
            target/release/focusmute-cli.exe
            target/wix/*.msi

  release-linux:
    name: Build & Release (Linux)
    needs: [check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux

      - name: Install Linux dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libpulse-dev pkg-config libasound2-dev libgtk-3-dev libxdo-dev libappindicator3-dev

      - name: Build release binaries
        run: cargo build --release

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install cargo-deb
        run: cargo binstall cargo-deb --no-confirm

      - name: Build .deb package
        run: cargo deb -p focusmute --no-build

      - name: Create tar.gz archive
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ARCHIVE="focusmute-${VERSION}-linux-x86_64"
          mkdir -p "${ARCHIVE}"
          cp target/release/focusmute "${ARCHIVE}/"
          cp target/release/focusmute-cli "${ARCHIVE}/"
          cp dist/linux/99-focusrite.rules "${ARCHIVE}/"
          cp dist/linux/focusmute.desktop "${ARCHIVE}/"
          cp dist/linux/focusmute-cli.desktop "${ARCHIVE}/"
          cp dist/linux/README-linux.md "${ARCHIVE}/README.md"
          cp LICENSE "${ARCHIVE}/"
          tar czf "${ARCHIVE}.tar.gz" "${ARCHIVE}"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            target/debian/*.deb
            focusmute-*-linux-x86_64.tar.gz

  publish:
    name: Create GitHub Release
    needs: [release-windows, release-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/windows-release/**/*.exe
            artifacts/windows-release/**/*.msi
            artifacts/linux-release/**/*.deb
            artifacts/linux-release/*.tar.gz
          generate_release_notes: true
